---
title: "Column Formatting"
author: "Emily de la Rua"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Column Formatting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

---------

## Introduction

This vignette shows how content in columns of a `listing_df` object can be formatted using the `rlistings` R package.

The following topics will be covered in this vignette:

- Adjusting default column formatting settings in `as_listing`
- Applying custom formatting to specific columns in `as_listing`
- Applying custom formatting settings when adding a new column to a listing via `add_listing_col`

To learn more about how listings are constructed using the `rlistings` package, see the [Getting Started vignette](rlistings.html).

---------

## Default Formatting in `as_listing`

When creating a listing with the `rlistings` package, you may want to customize content within one or more of your listing columns. In this section we will demonstrate how default formatting can be set within the `as_listing` function via the `default_formatting` parameter. 

The `default_formatting` argument to `as_listing` accepts a named list of format configurations to apply within your listing. Format configurations are created as `fmt_config` objects which contain 3 elements to control formatting:

1. `format`: A format label (string) or format function to apply when rendering values (see all valid options with `?formatters::list_valid_format_labels()`). Defaults to `NULL`.
2. `na_str`: A string that should be displayed in place of missing values. Defaults to `"NA"`.
3. `align`: Alignment that values should be rendered in the listing with. Defaults to `"center"`. Other options include `"left"`, `"right"`, `"decimal"`, `"dec_right"`, and `"dec_left"`.

The `default_formatting` argument by default uses the same format configuration for all columns in a listing, but also allows the user to set different format configurations for each data class present in your listing. The list supplied to `default_formatting` must contain a named element corresponding to every data class in your listing, or include the `"all"` element which applies by default any data classes that are not explicitly covered.

To demonstrate, we will create a basic listing below and customize formatting using the `default_formatting` parameter.

We begin by loading in the `rlistings` package. 

```{r, message=FALSE}
library(rlistings)
```

For the purpose of this example we will use the dummy ADAE dataset provided within the `formatters` package as our data frame, which consists of 48 columns of adverse event patient data, and one or more rows per patient. For the purpose of this example, we will subset the data and only use the first 10 records of the dataset. We will create some `NA` values in the data to showcase how `NA` values can be formatted.

```{r}
adae <- ex_adae[1:15, ]

set.seed(1)
adae <- as.data.frame(lapply(adae, function(x) replace(x, sample(length(x), 0.1 * length(x)), NA)))
```

Now we will create a basic listing.

```{r}
lsting_1 <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "AGE", "TRTSDTM"),
  disp_cols = c("BMRKR1", "ASEQ", "AESEV"),
)

lsting_1
```

Notice that all of the data in the table above is displayed as is with no rounding or formatting applied. All columns are centered and all `NA` values are displayed as `"NA"`.

Suppose we want to left align all of the columns in the listing and replace missing values with the string `"<No data>"`. This can be done by setting the `"all"` element in the list supplied to `default_formatting`, as shown in the following example.

```{r}
lsting_2 <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "AGE", "TRTSDTM"),
  disp_cols = c("BMRKR1", "ASEQ", "AESEV"),
  default_formatting = list(all = fmt_config(na_str = "<No data>", align = "left"))
)

lsting_2
```

Now consider that we may want to display our numeric columns with two decimal places and then align these columns on the decimal place. This can be done by adding a `"numeric"` element to the `default_formatting` list as follows:

```{r}
lsting_3 <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "AGE", "TRTSDTM"),
  disp_cols = c("BMRKR1", "ASEQ", "AESEV"),
  default_formatting = list(
    all = fmt_config(na_str = "<No data>", align = "left"),
    numeric = fmt_config(format = "xx.xx", na_str = "<No data>", align = "decimal")
  )
)

lsting_3
```

Along with the format strings listed by `formatters::list_valid_format_labels`, we can also specify a format _function_ to allow for more customized formats in our listing. In this following example, we will define and apply a custom format function to format date (`POSIXt` class) columns in our listing.

```{r}
# Custom format function - takes date format as input
date_fmt <- function(fmt) {
  function(x, ...) do.call(format, list(x = x, fmt))
}

lsting_4 <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "AGE", "TRTSDTM"),
  disp_cols = c("BMRKR1", "ASEQ", "AESEV"),
  default_formatting = list(
    all = fmt_config(na_str = "<No data>", align = "left"),
    numeric = fmt_config(format = "xx.xx", na_str = "<No data>", align = "decimal"),
    POSIXt = fmt_config(format = date_fmt("%B %d, %Y @ %I:%M %p %Z"), na_str = "<No data>")
  )
)

lsting_4
```

In the above listing, the `all` format configuration which originally applied to all columns in the listing now only applies to the two character/factor variables (`USUBJID` and `AESEV`). This is because all other data classes in the listing have been covered by other elements in the input list provided to the `default_formatting` argument. When format configurations are applied to a listing, all other applicable configurations take precedence over the `all` format configuration.

## Custom Column Formatting in `as_listing`

In this section we will demonstrate how custom formatting can be applied on a column-by-column basis rather than to an entire listing or all columns of a specified data class at once. 

Take, for example, `lsting_4` created in the previous section.

```{r}
lsting_4
```

This listing applies the same format configuration to all numeric columns. But in some cases, this broad generalization may not be what we want. In the above listing, the "Age" and "Analysis Sequence Number" columns contain only integer values, so it might make sense not to render these columns with two decimal places and only apply that format configuration to the "Continuous Level Biomarker 1" column. To do so, we can use the `col_formatting` argument to `as_listing`. Like `default_formatting`, this argument takes a named list of format configurations (`fmt_config` objects) as input, but unlike `default_formatting` the names of the list elements correspond to column names. The `col_formatting` argument can be used both in addition to and instead of the `default_formatting` argument, depending on the requirements of your listing.

See the following example which demonstrates how `col_formatting` can be used with the `BMRKR1` column. We will use the `"xx"` format and use right alignment for the two other numeric columns.

```{r}
lsting_5 <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "AGE", "TRTSDTM"),
  disp_cols = c("BMRKR1", "ASEQ", "AESEV"),
  default_formatting = list(
    all = fmt_config(na_str = "<No data>", align = "left"),
    numeric = fmt_config(format = "xx", na_str = "<No data>", align = "right"),
    POSIXt = fmt_config(format = date_fmt("%B %d, %Y @ %I:%M %p %Z"), na_str = "<No data>")
  ),
  col_formatting = list(
    BMRKR1 = fmt_config(format = "xx.xx", na_str = "<No data>", align = "decimal")
  )
)

lsting_5
```

Now all of the columns in our listing are formatted according to our specifications. Notice that the format configurations supplied to `col_formatting` for individual columns take precedence over any format configurations supplied to `default_formatting`.

## Adding Formatted Columns to a Listing via `add_listing_col`

In some cases, you may want to add a new column with its own formatting settings to an already existing listing. In this section, we will demonstrate how this can be accomplished using the `add_listing_col` function. Additional columns can be added to a listing using the `add_listing_col` function. These added columns will not inherit format configurations previously applied, so formatting for the new column must be specified _within_ the `add_listing_col` function. Instead of creating a `fmt_config` object, the `format`, `na_str`, and `align` specifications can be supplied directly to `add_listing_col` via its the parameters by the same names. If these parameters are not specified, default values of `NULL`, `"NA"`, and `"left"` will be used for `format`, `na_str`, and `align`, respectively.

Now suppose we want to add a column to `lsting_5` created in the previous section which calculates the length of the analysis (in days) by subtracting "Analysis Start Relative Day" (`ASTDY`) from "Analysis End Relative Day" (`AENDY`). This can be done as follows to create our complete listing:

```{r}
lsting_6 <- lsting_5 %>%
  add_listing_col(
    name = "Length of\nAnalysis",
    fun = function(df) df$AENDY - df$ASTDY,
    format = "xx.x",
    na_str = "NE",
    align = "center"
  )

lsting_6
```

---------

## Summary

In this vignette you have learned how column formatting can be configured using the `default_formatting` and `col_formatting` arguments to `as_listing` and the `add_listing_col` function to customize how your listing is rendered.

**For more information please explore the [rlistings website](https://insightsengineering.github.io/rlistings/main/).**
