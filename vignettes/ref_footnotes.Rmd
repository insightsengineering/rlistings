---
title: "Referential Footnotes"
author: "Emily de la Rua"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Referential Footnotes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

---------

## Introduction

There is currently no formal method for adding referential footnotes to a listing object. This vignette demonstrates how referential footnotes can be added to a `listing_df` object via a workaround applied during pre-processing.

To learn more about how listings are constructed using the `rlistings` package, see the [Getting Started vignette](rlistings.html).

---------

## Referential Footnotes Workaround

When creating a listing with the `rlistings` package, you may want to add referential footnotes, similar to how referential footnotes can be added to `rtable` objects. Since there is no formal method in `rlistings` for applying referential footnotes to a `listing_df` object, we will demonstrate how a workaround can be applied to add a set of pseudo-referential footnotes to your listing.

To demonstrate, we will create a basic listing below.

We begin by loading in the `rlistings` package. 

```{r, message=FALSE}
library(rlistings)
```

For this example, we will use the dummy ADAE dataset provided within the `formatters` package as our data frame, which consists of 48 columns of adverse event patient data, and one or more rows per patient. For the purpose of this example, we will subset the data and only use the first 10 records of the dataset.

```{r}
adae <- ex_adae[1:15, ]
adae <- adae %>% dplyr::arrange(USUBJID, ARM, ASEQ)
```

Now we will create a basic listing.

```{r}
lsting <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "ARM", "ASEQ"),
  disp_cols = c("BMRKR1", "AESEV"),
)

lsting
```

Suppose we first want to add a referential footnote to the `ARM` column for records with arm "C: Combination" which also have analysis sequence number 1 or 2. Referential footnotes can be added to any variable by converting the variable to a factor, editing the variable values, and adding a corresponding footnote below the listing. We will add our first referential footnote in the `ARM` column. To ensure that levels are correctly ordered, make sure to first specify the new level order.

```{r}
# Save variable labels for your data to add back in after mutating dataset
df_lbls <- var_labels(adae)

# Specify order of levels with new referential footnotes added
levels(adae$ARM) <- c("A: Drug X", "B: Placebo", "C: Combination", "C: Combination*")

# Mutate variable where referential footnotes are to be added according to conditions
adae <- adae %>%
  dplyr::mutate(ARM = ifelse(ARM == "C: Combination" & ASEQ %in% 1:2, paste0(ARM, "*"), as.character(ARM))) %>%
  dplyr::arrange(USUBJID, ARM, ASEQ)

# Add back data variable labels
var_labels(adae) <- df_lbls

# Generate listing
lsting <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "ARM", "ASEQ"),
  disp_cols = c("BMRKR1", "AESEV"),
)

lsting
```

We then add the corresponding footnote below the listing as follows:

```{r}
ref_fns <- c("*   Records with condition 1")

# Append referential footnote(s) to existing footnotes
main_footer(lsting) <- c(main_footer(lsting), ref_fns)

lsting
```

Additional referential footnotes can be added to the data be repeating the above steps. For example, we can add a second referential footnote to the `AESEV` column for records with analysis toxicity grade 5.

```{r}
# Save variable labels for your data to add back in after mutating dataset
df_lbls <- var_labels(adae)

# Specify order of levels with new referential footnotes added
levels(adae$AESEV) <- c("MILD", "MODERATE", "SEVERE", "SEVERE**")

# Mutate variable where referential footnotes are to be added according to conditions
adae <- adae %>%
  dplyr::mutate(AESEV = ifelse(AETOXGR == 5, paste0(AESEV, "**"), as.character(AESEV)))

# Add back data variable labels
var_labels(adae) <- df_lbls

# Generate listing
lsting <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "ARM", "ASEQ"),
  disp_cols = c("BMRKR1", "AESEV"),
)

ref_fns <- c(ref_fns, "**  Records with analysis toxicity grade 5")

# Append referential footnote(s) to existing footnotes
main_footer(lsting) <- c(main_footer(lsting), ref_fns)

lsting
```

We can also add referential footnotes to our column header labels. Suppose we want to add a referential footnote to the `USUBJID` column label. We can do so by editing the `USUBJID` variable label and adding the footnote text as follows:

```{r}
# Add back data variable labels
adae <- adae %>% var_relabel(
  USUBJID = paste0(var_labels(adae)[["USUBJID"]], "***")
)

# Generate listing
lsting <- as_listing(
  df = adae,
  key_cols = c("USUBJID", "ARM", "ASEQ"),
  disp_cols = c("BMRKR1", "AESEV")
)

ref_fns <- c(ref_fns, "*** ID column")

# Append referential footnote(s) to existing footnotes
main_footer(lsting) <- c(main_footer(lsting), ref_fns)

lsting
```

---------

## Summary

In this vignette, you have learned how a pre-processing workaround can be applied to add referential footnotes to listings.

**For more information please explore the [rlistings website](https://insightsengineering.github.io/rlistings/main/).**
